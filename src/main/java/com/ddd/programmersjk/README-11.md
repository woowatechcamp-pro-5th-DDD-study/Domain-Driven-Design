##11. CQRS

## 11.1 단일 모델의 단점
- 주문 내역 조회 기능을 구현하려면 여러 애그리거트에서 데이터를 가져와야 한다. Order에서 주문 정보를 가져와야 하고 Product에서 상품 이름을
가져와야 하고 Member에서 회원 이름과 ID를 가져와야 한다.
- 조회에서 여러 애그리거트의 데이터가 필요하면 식별자를 이용해 애그리거트를 참조하는 방식은 즉시로딩과 같은 JPA 쿼리 관련 최적화 기능을
사용할 수 없다.
- 식별자가 아니라 연관관계를 맺어도 조회 하면에 여러 애그리거트의 데이터가 필요하기 때문에 JPA의 네이티브 쿼리를 사용해야 할 수도 있다.
- 이런 고민이 발생하는 이유는 ORM을 사용하여 도메인의 상태를 변경하는 것은 적합하지만 복잡한 조회화면을 보여주기에는 고려할게 많아
구현을 복잡하게 만드는 원인이 된다.
- 이런 구현 복잡도를 낮추는 간단한 방버이 있는데 바로 상태변경과 조회를 위한 모데을 분리하는 것이다.

## 11.2 CQRS
- 시스템이 제공하는 기능은 **상태를 변경**하거나 **상태를 조회**하는 기능으로 나눌 수 있다.
- 도메인 모델 관점에서 상태 변경기능은 주로 한 애그리거트의 상태를 변경하는 반면에 조회기느은 두 개 이상의 애그리거트가 필요할 떄가 많다.
- 상태를 변경하는 범위와 조회하는 범위가 정확하게 일치하지 않기 때문에 단일 모델로 두 종류의 기능을 구현하면 모델이 불필요하게 복잡해진다.
이때 복잡도를 해결하기 위해 CQRS를 사용할 수 있다.
- CQRS는 복잡한 도메인에 적합하다. 도메인이 복잡할수록 명령 기능과 조회 기능이 다루는 데이터 범위에 차이가 난다. 이 두기능을 단일 모델로
처리하면 조회 속도를 위해 모델 구현이 필요 이상으로 복잡해진다. 예를 들어 주문/판매 통계를 조회한다고 가정하자. JPA 단일 도메일 모델을 사용하면
통계를 빠르게 조회하기 위해 JPA와 관련된 다양한 성능 관련 기능을 모델에 적용해야 한다. 이런 도메인에 CQRS를 적용하면 통계를 위한 조회 모델을
별도로 만들기 때문에 도메인이 복잡해 지는 것을 막을 수 있다.
- CQRS를 사용하면 각 모델에 맞는 구현 기술을 선택할 수 있다. 예를 들어 명령 모델은 JPA를 사용하고 조회 모델은 SQL로 데이터를 조회할 떄 
좋은 마이바티스르 사용할 수 있다.

### 11.2.1 웹과 CQRS
- 일반적인 웹 서비스는 상태를 변경하는 요청보다 조회하는 요청이 많다. 조회 성능을 높이기 위해 다양한 기법을 사용하는데 쿼리 최적화르 하기도 하고
별도의 캐싱 서버를 두고 응답 속도를 높이기도 한다.
- 이렇게 조회 속도를 높이기 위해 다양한 기법을 사용하는것은 결과적으로 CQRS를 적용하는 것과 같은 효과를 만든다. 대규모 웹 트래픽이
발생하는 웹 서비스는 알게 모르게 CQRS를 적용하게 된다.

### 11.2.2 CQRS 장단점
- CQRS로 얻을 수 있는 장점은 명령 모델을 구현할 때 도메인 자체에 집중할 수 있다는 점이다. 복잡한 도메인은 주로 상태 변경 로직이 복잡한데
명령 모델과 조회 모델을 구분하면 조회 성능을 위한 코드가 명령 모델에 없으므로 도메인 로직을 구현하는데 집중할 수 있고 조회관련 로직이 사라져
복잡도가 낮아진다.
- 또 다른 장점으로 성능을 향상시키는데 유리하다. 조회 단위로 캐시를 적용할 수 있고 조회에 특화된 쿼리를 마음대로 사용할 수 있다. 캐시 뿐
아니라 조회 전용 저장소를 사용하면 조회 처리량을 대폭 늘릴수도 있다.
- 반대로 단점은 구현해야 할 코드가 더 많다는 점이다. 도메인이 복잡하거나 대규모 트래픽이 발생하는 서비스라면 조회 전용 모델을 만드는 것이
향휴 유지보수에 유리하다. 반면에 도메인이 단순하거나 트래픽이 적다면 CQRS를 적용해 얻을 이점이 있는지 따져봐야 한다.
- 두번쨰 단점은 더 많은 구현 기술이 필요할 수 있다. 명령 모델과 조회 모델을 다른 기술을 사용해 구현할 수도 있고 다른 저장소를 사용할 수도 있다.
경우에 따라서는 데이터 동기화를 위해 메시징 시스템을 도입해야 할 수도 있다.
- 이러한 장단점을 고려해서 CQRS 패턴을 도입할지 여부를 결정해야 한다. 도메인이 복잡하지 않은데 CQRS를 도입하면 두 모델을 유지하는 비용만 높아지고 얻을 수 있는 이점은 없다.